name: Suggest Package Version Bump

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
  workflow_dispatch:
    inputs:
      base-ref:
        description: "Base branch or ref to compare against"
        required: false
        default: ""

jobs:
  suggest:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    env:
      DEFAULT_BASE: ${{ github.event.repository.default_branch }}
      BASE_INPUT: ${{ github.event.inputs.base-ref || '' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.sha || github.sha }}

      - name: Determine base reference
        id: base
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "branch=${{ github.event.pull_request.base.ref }}" >> "$GITHUB_OUTPUT"
            echo "sha=${{ github.event.pull_request.base.sha }}" >> "$GITHUB_OUTPUT"
          else
            REF="$BASE_INPUT"
            if [ -z "$REF" ]; then
              REF="$DEFAULT_BASE"
            fi
            git fetch origin "$REF"
            SHA=$(git rev-parse "origin/$REF")
            echo "branch=$REF" >> "$GITHUB_OUTPUT"
            echo "sha=$SHA" >> "$GITHUB_OUTPUT"
          fi

      - name: Fetch base branch history
        if: steps.base.outputs.branch
        run: git fetch origin "${{ steps.base.outputs.branch }}"

      - name: Analyze commits and suggest bump
        id: suggest
        env:
          BASE_SHA: ${{ steps.base.outputs.sha }}
          HEAD_SHA: ${{ github.event.pull_request.head.sha || github.sha }}
        run: |
          npm install semver@7 --no-save >/dev/null 2>&1
          node <<'EOF'
          const fs = require('fs');
          const { execSync } = require('child_process');

          const baseSha = process.env.BASE_SHA;
          const headSha = process.env.HEAD_SHA;

          if (!fs.existsSync('package.json')) {
            console.error('package.json not found');
            process.exit(1);
          }

          const pkg = JSON.parse(fs.readFileSync('package.json', 'utf8'));
          const current = pkg.version;

          function readLog(range) {
            if (!range) return '';
            try {
              return execSync(`git log ${range} --pretty=format:%s%n%b`, { encoding: 'utf8' });
            } catch (error) {
              return '';
            }
          }

          const range = baseSha ? `${baseSha}..${headSha}` : '';
          const log = readLog(range);

          const commits = log.split(/\n(?=\w)/).filter(Boolean);

          let recommendation = 'patch';

          const lines = log.split('\n');
          for (const entry of lines) {
            if (!entry) continue;
            const header = entry.trim();
            if (/BREAKING CHANGE/i.test(header) || /!:\s/.test(header)) {
              recommendation = 'major';
              break;
            }
            if (/^feat(\(|:)/i.test(header)) {
              if (recommendation !== 'major') {
                recommendation = 'minor';
              }
            }
          }

          const semver = require('semver');

          let next = current;
          if (semver.valid(current)) {
            next = semver.inc(current, recommendation) || current;
          } else {
            const [major = '0', minor = '0', patch = '0'] = current.split('.');
            const nums = [parseInt(major, 10) || 0, parseInt(minor, 10) || 0, parseInt(patch, 10) || 0];
            if (recommendation === 'major') {
              nums[0] += 1; nums[1] = 0; nums[2] = 0;
            } else if (recommendation === 'minor') {
              nums[1] += 1; nums[2] = 0;
            } else {
              nums[2] += 1;
            }
            next = nums.join('.');
          }

          const summary = {
            recommendation,
            current,
            next,
            commitCount: commits.length,
          };

          fs.appendFileSync(process.env.GITHUB_OUTPUT, `recommended=${summary.recommendation}\n`);
          fs.appendFileSync(process.env.GITHUB_OUTPUT, `current=${summary.current}\n`);
          fs.appendFileSync(process.env.GITHUB_OUTPUT, `next=${summary.next}\n`);
          fs.appendFileSync(process.env.GITHUB_OUTPUT, `commit_count=${summary.commitCount}\n`);

          console.log(summary);
          EOF

      - name: Update pull request comment
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        env:
          RECOMMENDED: ${{ steps.suggest.outputs.recommended }}
          CURRENT: ${{ steps.suggest.outputs.current }}
          NEXT: ${{ steps.suggest.outputs.next }}
          COMMITS: ${{ steps.suggest.outputs.commit_count }}
        with:
          script: |
            const marker = '<!-- version-bump-suggestion -->';
            const body = `${marker}
            ### ðŸ“¦ Suggested Version Bump

            | Metric | Value |
            | --- | --- |
            | Current version | \
` + process.env.CURRENT + ` |
            | Recommended bump | ${process.env.RECOMMENDED || 'patch'} |
            | Suggested next version | ${process.env.NEXT || 'N/A'} |
            | Commits analyzed | ${process.env.COMMITS || '0'} |

            > Tip: Update \`package.json\` to the suggested version (or adjust as needed) before merging.
            `;

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              per_page: 100,
            });

            const existing = comments.find(comment => comment.body && comment.body.includes(marker));

            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body,
              });
            }

      - name: Print suggestion summary
        run: |
          echo "Current version: ${{ steps.suggest.outputs.current }}"
          echo "Recommended bump: ${{ steps.suggest.outputs.recommended }}"
          echo "Suggested next version: ${{ steps.suggest.outputs.next }}"
          echo "Commits analyzed: ${{ steps.suggest.outputs.commit_count }}"